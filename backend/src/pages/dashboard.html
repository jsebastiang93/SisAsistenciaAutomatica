<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Consulta de Asistencia</title>
  <link rel="stylesheet" href="../../styles.css" />
  <style>
    .scan-btn {
      background-color: #009688;
      color: white;
      padding: 10px 20px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      border-radius: 4px;
      margin-right: 10px;
    }
    .scan-btn:hover {
      background-color: #00796b;
    }
    .scan-btn.stop {
      background-color: #b71c1c;
    }
    .scan-btn.stop:hover {
      background-color: #8e0000;
    }
    #respuestaEscaneo {
      margin-top: 10px;
      font-weight: bold;
    }
    #modalConfirmacion {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    #modalConfirmacion .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      max-width: 400px;
    }
    #codigoEscanerModal {
      padding: 10px;
      width: 90%;
      font-size: 16px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <!-- Modal -->
  <div id="modalConfirmacion">
    <div class="modal-content">
      <p>Escanee el c√≥digo y confirme el env√≠o</p>
      <form onsubmit="event.preventDefault(); confirmarEnvioDesdeModal();">
        <input type="text" id="codigoEscanerModal" placeholder="Escanea aqu√≠..." autocomplete="off" />
        <div style="margin-top: 20px;">
          <button type="submit" class="scan-btn">Aceptar</button>
          <button type="button" onclick="cerrarModal()" class="scan-btn stop">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Encabezado -->
  <header class="header-banner">
    <div class="banner">
      <img src="../assets/icono-asistencia.svg" alt="√çcono asistencia" class="icono-banner" />
      <span class="titulo-banner">Sistema de asistencia autom√°tica</span>
      <div class="user-info">
        <p>Nazly Roc√≠o<br><span>Periodo 2025-1</span></p>
        <a href="../../index.html">
          <img class="logout-btn" src="../assets/logout-btn.svg" alt="logout-btn">
        </a>
      </div>
    </div>
  </header>

  <!-- Contenido principal -->
  <div class="dashboard">
    <nav class="sidebar">
      <h3>Men√∫</h3>
      <ul>
        <li><strong>Consulta de asistencia</strong></li>
      </ul>
      <h3>Configuraci√≥n</h3>
      <ul>
        <li>Periodos acad√©micos</li>
        <li>Programas acad√©micos</li>
        <li>Excusas por inasistencia</li>
        <li>Estudiantes</li>
        <li>Docentes</li>
      </ul>
    </nav>

    <main class="content">
      <h2>Consulta de asistencia a clases</h2>

      <!-- Bot√≥n de esc√°ner -->
      <div style="margin-top: 20px;">
        <button onclick="mostrarModalConfirmacion()" class="scan-btn">üü¢ Escanear documento</button>
        <p id="respuestaEscaneo"></p>
      </div>

      <!-- Filtros -->
      <div class="filters">
        <label>Per√≠odo acad√©mico
          <select><option>2025-1 Primer semestre</option></select>
        </label>
        <label>Asignatura
          <select><option>Electiva de Profundizaci√≥n III</option></select>
        </label>
        <label>Fecha de clase
          <input type="date" value="2025-04-29" />
        </label>
        <button class="search-btn">üîç</button>
      </div>

      <div class="stats">
        <div class="stat yellow">
          <span class="numero">13</span>
          <span class="texto">Estudiantes Matriculados</span>
        </div>
        <div class="stat green">
          <span class="numero">8</span>
          <span class="texto">Asistencias</span>
        </div>
        <div class="stat red">
          <span class="numero">5</span>
          <span class="texto">Inasistencias</span>
        </div>
        <div class="stat blue">
          <span class="numero">0</span>
          <span class="texto">Excusas por Inasistencia</span>
        </div>
      </div>      

      <div class="class-info">
        <p><strong>Docente:</strong> Nazly Roc√≠o Hincapi√© Monsalve</p>
        <p><strong>D√≠a de semana de clase:</strong> Martes</p>
        <p><strong>Horario de la clase:</strong> 06:30 pm - 09:30 pm</p>
      </div>

      <table>
        <thead>
          <tr>
            <th>Nombre del Estudiante</th>
            <th>Hora de registro</th>
            <th>Estado</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>397507 Wilson David Menza Pavi</td>
            <td>06:35 pm</td>
            <td>ASISTI√ì</td>
            <td><a href="#">Adicionar excusa</a></td>
          </tr>
        </tbody>
      </table>
    </main>
  </div>

  <footer>
    <p>Copyright ¬© 2025 - Unicat√≥lica | Versi√≥n 0.0.1 | Todos los derechos reservados</p>
  </footer>

  <!-- Script -->
  <script>
  let escaneoManual = false;
  let ultimaLectura = 0;

  function confirmarEnvioDesdeModal() {
    const codigo = document.getElementById("codigoEscanerModal").value.trim();

    if (codigo === "") {
      alert("‚ö†Ô∏è Por favor escanee o ingrese un c√≥digo.");
      return;
    }

    fetch("http://localhost:8000/iniciar-escaner", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ codigo })
    })
    .then(response => response.json())
    .then(data => {
      document.getElementById("respuestaEscaneo").innerText =
        data.mensaje || data.error || "Respuesta inesperada.";
    })
    .catch(error => {
      document.getElementById("respuestaEscaneo").innerText =
        "‚ùå Error al conectar con el servidor.";
      console.error("Error:", error);
    });

    cerrarModal();
  }

  function mostrarModalConfirmacion() {
    const modal = document.getElementById("modalConfirmacion");
    const input = document.getElementById("codigoEscanerModal");
    modal.style.display = "flex";
    input.value = "";
    input.focus();
    escaneoManual = false; // ‚Üê Reiniciar al mostrar el modal
  }

  function cerrarModal() {
    document.getElementById("modalConfirmacion").style.display = "none";
    document.getElementById("codigoEscanerModal").value = "";
    escaneoManual = false;
  }

  // Marcar si el usuario enfoc√≥ el input manualmente
  const inputCodigo = document.getElementById("codigoEscanerModal");

  inputCodigo.addEventListener("focus", () => {
    escaneoManual = true;
  });

  inputCodigo.addEventListener("blur", () => {
    escaneoManual = false;
  });

  // Capturar Enter con l√≥gica de control
  inputCodigo.addEventListener("keydown", function(event) {
    if (event.key === "Enter") {
      const ahora = Date.now();
      
      // ‚ö†Ô∏è Prevenir si fue Enter autom√°tico (r√°pido tras escaneo)
      if (!escaneoManual || ahora - ultimaLectura < 300) {
        event.preventDefault();
        return;
      }

      ultimaLectura = ahora;
      confirmarEnvioDesdeModal();
    }
  });

  // Evitar Enter global cuando no corresponde
  document.addEventListener("keydown", function(event) {
    if (event.key === "Enter") {
      const modal = document.getElementById("modalConfirmacion");
      const input = document.getElementById("codigoEscanerModal");

      // Si no estamos dentro del modal o el input no est√° enfocado, prevenir
      if (modal.style.display === "flex" && document.activeElement !== input) {
        event.preventDefault();
      }
      if (modal.style.display !== "flex") {
        event.preventDefault();
      }
    }
  });
</script>

</body>
</html>